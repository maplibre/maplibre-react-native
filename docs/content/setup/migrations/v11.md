# Migrating to v11

MapLibre React Native v11 is the first release to only support the new architecture. As this required significant changes to the implementation, the APIs where also improved and are based upon MapLibre GL.

## Changes to `MapView` Component

### Android View uses `GLSurfaceView` by default

On Android the `MapView` uses `GLSurfaceView` per default instead of `TextureView` for native rendering. This aligns with the default of the native SDKs, this switch is [pre-dating MapLibre](https://blog.mapbox.com/asynchronous-rendering-on-android-831722ac1837) and was never propagated to the React Native wrapper. To fall back to the `TextureView` use the `androidView="texture"` prop.

### Removed Props

The following props have been removed from the `MapView` without replacement:

- `localizeLabels`: This was used in conjunction with Mapbox specific map styles for toggling localization, MapLibre aims to be vendor-agnostic and the prop has therefore been removed
- `regionWillChangeDebounceTime` & `regionDidChangeDebounceTime`: Debouncing should be handled in the app code if needed

### Ornament Props

All ornaments (attribution, logo, compass) use an aligned API. Enable/disable the visibility with the `attribution`/`logo`/`compass` boolean props. Position them with the `attributionPosition`/`logoPosition`/`compassPosition` props which only accepts an object with `top`/`bottom` and `left`/`right` properties.

### `contentInset`

Uses unified `ViewPadding` type:

```diff
<MapView
-  contentInset={[16, 16, 16, 16]}
+  contentInset={{ top: 16, right: 16, bottom: 16, left: 16 }}
/>
```

### Interaction Props

Interaction props have been aligned with the MapLibre GL API as far as possible.

```diff
<MapView
-  scrollEnabled={false}
+  dragPan={false}
-  zoomEnabled={false}
+  touchAndDoubleTapZoom={false}
-  rotateEnabled={false}
+  touchRotate={false}
-  pitchEnabled={false}
+  touchPitch={false}
/>
```

### Events

Events follow the pattern of `NativeSyntheticEvent` and passes the payload in the `nativeEvent` property.

### Imperative Methods on `MapRef`

Imperative methods have been aligned with the MapLibre GL API as far as possible.

- Renamed methods:
  - `getVisibleBounds()` -> `getBounds()`
  - `getPointInView()` -> `project()`
  - `getCoordinateFromView()` -> `unproject()`
- Unified methods:
  - `queryRenderedFeaturesAtPoint()` & `queryRenderedFeaturesInRect()` -> `queryRenderedFeatures()`
    - Instead of passing pixel coordinates, geographic coordinates are being required to query
- More complete API by adding:
  - `getBearing()`
  - `getPitch()`
  - `getViewState()`

## `Light` Component removed

The `Light` component has been removed. Use the `light` prop on `MapView` instead.

```diff
<MapView
+  light={{
+    position: [1.5, 90, 80],
+    color: "#ffffff",
+    intensity: 0.5,
+  }}
>
-  <Light
-    style={{
-      position: [1.5, 90, 80],
-      color: "#ffffff",
-      intensity: 0.5,
-    }}
-  />
</MapView>
```

## Changes to `Camera` Component

### Changes to Camera Stop Props

The prop was renamed and the structure was aligned with MapLibre GL and `react-map-gl`:

```diff
<Camera
-  centerCoordinate={[longitude, latitude]}
+  center={[ longitude, latitude ]}
-  zoomLevel={10}
+  zoom={10}
- heading={15}
+  bearing={15}
  pitch={30}
-  animationDuration={2000}
+  duration={2000}
-  animationMode="flyTo"
+  easing="fly"
/>
```

String Literal `CameraAnimationMode` has been renamed to `CameraEasing` and changed as follows:

- `moveTo` -> `undefined`
- `linearTo` -> `linear`
- `easeTo` -> `ease`
- `flyTo` -> `fly`

### Prop `defaultSettings` changed to `initialViewState`

The prop was renamed and the structure was aligned with MapLibre GL and `react-map-gl`:

```diff
<Camera
-  defaultSettings={{
+  initialViewState={{
-    centerCoordinate: [longitude, latitude],
+    center: [longitude, latitude],
-    zoomLevel: 10,
+    zoom: 10,
-    heading: 15,
+    bearing: 15
    pitch: 30,
-    bounds: {
-      ne: [east, north],
-      sw: [west, south],
-      paddingTop: 16,
-      paddingRight: 16,
-      paddingBottom: 16,
-      paddingLeft: 16,
-    },
+    bounds: [west, south, east, north],
+    padding: { top: 16, right: 16, bottom: 16, left: 16 },
  }}
/>
```

### Follow Prop Changes

The `followUserLocation` and `followUserMode` prop has been unified to `trackUserLocation`.

The enum `UserTrackingMode` has been replaced by the string literal `TrackUserLocation`:

- `normal` -> `default`
- `compass` -> `heading`
- `course` -> `course`

The `follow` props to control the camera during tracking have been removed in favor of the default camera stop props:

```diff
<Camera
-  followUserLocation
-  followUserMode="normal"
+  trackUserLocation="default"
-  followZoomLevel={15}
+  zoom={15}
-  followHeading={0}
+  bearing={0}
-  followPitch={45}
+  pitch={45}
/>
```

### Imperative Methods on `CameraRef`

Imperative methods have been aligned with the MapLibre GL API as far as possible.

- `setCamera()` -> `setStop()`
- `moveTo()` -> `jumpTo()`
- More complete API by adding:
  - `easeTo()`

## Changes to `Source` Components

### Props

#### Optional `id` Prop

The `id` prop is optional and will be auto-generated if not provided:

```diff
<ShapeSource
-  id="my-source"
+  id="my-source"
  data={geojson}
/>
```

#### `tiles`, `minzoom`, `maxzoom`, `scheme` Props (only `RasterSource` & `VectorSource`)

Tiled sources now use MapLibre Style spec aligned props:

```diff
<VectorSource
-  tileUrlTemplates={['https://example.com/tiles/{z}/{x}/{y}.pbf']}
+  tiles={['https://example.com/tiles/{z}/{x}/{y}.pbf']}
-  minZoomLevel={0}
+  minzoom={0}
-  maxZoomLevel={14}
+  maxzoom={14}
-  tms
+  scheme="tms"
/>
```

#### `hitbox` Structure Changed (only `ShapeSource` & `VectorSource`)

The `hitbox` prop uses the unified `ViewPadding` type instead of width/height:

```diff
<ShapeSource
-  hitbox={{ width: 44, height: 44 }}
+  hitbox={{ top: 22, right: 22, bottom: 22, left: 22 }}
/>
```

### Events (only `ShapeSource` & `VectorSource`)

The `onPress` event follows the `NativeSyntheticEvent` pattern with the payload in `nativeEvent`:

```diff
<ShapeSource
  onPress={(event) => {
-    const { features, coordinates, point } = event;
+    const { features, lngLat, point } = event.nativeEvent;
  }}
/>
```

Also `onPress` bubbles up to `MapView` by default. To prevent this, call `event.stopPropagation()`.

### Specific Changes to `ShapeSource` Component

#### Unified `data` Prop

The separate `url` and `shape` props have been unified into a single `data`, to align with MapLibre GL JS. The `data` prop accepts both URL strings and GeoJSON objects:

```diff
<ShapeSource
-  url="https://example.com/data.geojson"
+  data="https://example.com/data.geojson"
/>

<ShapeSource
-  shape={geojson}
+  data={geojson}
/>
```

#### Renamed Cluster Props

Several props have been renamed to align with the MapLibre Style Spec and MapLibre GL JS:

```diff
<ShapeSource
-  clusterMaxZoomLevel={14}
+  clusterMaxZoom={14}
/>
```

### Imperative Methods on `ShapeSourceRef`

Several imperative methods have been renamed and simplified to align with MapLibre GL JS:

#### `features()` → `getData()`

The method has been renamed:

```diff
-const featureCollection = await shapeSourceRef.current.features(filter);
+const featureCollection = await shapeSourceRef.current.getData(filter);
```

Due to MapLibre Native limitations this is not the original data but always a `FeatureCollection`. For example a `GeometryCollection` will always be transformed to a `FeatureCollection`.

#### Cluster Methods use `clusterId` Parameter instead of GeoJSON Feature

All cluster-related methods accept a `clusterId` number instead of a GeoJSON Feature to align with MapLibre GL JS. The `clusterId` can be obtained from the `cluster_id` property of a cluster feature:

```diff
+const clusterId = clusterFeature.properties.cluster_id;

-const zoom = await shapeSourceRef.current.getClusterExpansionZoom(clusterFeature);
+const zoom = await shapeSourceRef.current.getClusterExpansionZoom(clusterId);

-const leaves = await shapeSourceRef.current.getClusterLeaves(clusterFeature, 10, 0);
+const leaves = await shapeSourceRef.current.getClusterLeaves(clusterId, 10, 0);

-const children = await shapeSourceRef.current.getClusterChildren(clusterFeature);
+const children = await shapeSourceRef.current.getClusterChildren(clusterId);
```

#### Return Types

The cluster methods return `GeoJSON.Feature[]` instead of `GeoJSON.FeatureCollection`:

```diff
-const leaves: GeoJSON.FeatureCollection = await shapeSourceRef.current.getClusterLeaves(clusterId, 10, 0);
+const leaves: GeoJSON.Feature[] = await shapeSourceRef.current.getClusterLeaves(clusterId, 10, 0);
```

### Specific Changes to `VectorSource` Component

### Imperative Methods on `VectorSourceRef`

The imperative method has been renamed and simplified to align with MapLibre GL JS:

#### `features()` → `querySourceFeatures()`

The method has been renamed, parameters support only one source layer, get passed as and object and the return type changed to a `GeoJSON.Feature[]`:

```diff
-const featureCollection: GeoJSON.FeatureCollection = await vectorSourceRef.current.features([sourceLayer], filter);
+const features: GeoJSON.Feature[] = await vectorSourceRef.current.querySourceFeatures({ sourceLayer, filter });
```

## Changes to `LocationManager` Module

### `GeolocationPosition` Type

The `LocationManager` module emits `GeolocationPosition` type, renamed from `Location` type. It also reassembles the web [`GeolocationPosition`](https://developer.mozilla.org/en-US/docs/Web/API/GeolocationPosition) much more closely. Previously there was partial support for `heading` and `course`. This has been unified as defined by the spec to `heading` which gives the direction of travel on both platforms. Retrieving the compass direction is not supported due to native limitations.

### Incorporation of `requestAndroidPermissions` into unified `requestPermissions`

The `LocationManager` incorporates a `requestPermissions` function, which supports Android and iOS. The standalone `requestAndroidPermissions` function has been removed:

```diff
-requestAndroidPermissions()
+LocationManager.requestPermissions()
```

## Changes to `UserLocation` Component

### Replaced `onUpdate` with `useCurrentPosition` Hook

The `onUpdate` prop has been removed in favor of the new `useCurrentPosition` hook for accessing the user location data:

```diff
+const position = useCurrentPosition();

return (
  <UserLocation
-    onUpdate={(position) => {
-      // ...
-    }}
  />
)
```

### Added the `accuracy` Prop

To show the accuracy circle around the user location set the `accuracy` prop to `true`. This replaces the previous circle that didn't have any meaning:

```diff
<UserLocation
+  accuracy
/>
```

### Separation of `NativeUserLocation`

The `NativeUserLocation`, which previously was used for `renderMode="native"`, has been branched out as a separate component:

```diff
-<UserLocation renderMode="native" />
+<NativeUserLocation />
```

This component only relies on the default MapLibre Native user location implementations without any custom React Native customizations.

## Changes to `LogManager` Module

The `Logging` module has been renamed to `LogManager` for consistency with other modules.

If you want to implement a custom log handler, use the `onLog` function instead of `setLogCallback`:

```diff
-Logging.setLogCallback((event) => {
+LogManager.onLog((event) => {
  console.log(event.message);
  return true;
});
```

The `LogLevel` `warning` has been renamed to `warn` to match `console.warn`.
